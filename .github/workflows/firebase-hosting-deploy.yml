name: Entur/Firebase/Deploy

on:
  workflow_call:
    inputs:
      gcp_project_id:
        required: true
        type: string
        description: "GCP Project ID"
      environment:
        required: true
        type: string
        description: "Environment to deploy to (dev, tst, prd)"
      entry_point:
        type: string
        description: "Entry point folder to deploy (Same folder as .firebase.json is located)"
        default: "."
      build_artifact_name:
        description: "Name of GitHub artifact to add to build"
        type: string
      build_artifact_path:
        description: "Path to the artifact"
        type: string
        default: "build"
      timeout_minutes:
        description: "Timeout in minutes"
        type: number
        default: 20
    outputs:
      details_url:
        value: ${{ jobs.deploy.outputs.details_url }}
      all_urls:
        value: ${{ jobs.deploy.outputs.urls }}

jobs:
  deploy:
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}
    environment: ${{ inputs.environment }}
    outputs:
      details_url: ${{ steps.firebase-deploy.outputs.details_url }}
      urls: ${{ steps.firebase-deploy.outputs.urls }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Authenticate with GCP
        id: auth
        uses: "google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093" # v3.0.0
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT }}
          create_credentials_file: true

      - name: Set service account key
        env:
          SERVICE_ACCOUNT_KEY_PATH: ${{ steps.auth.outputs.credentials_file_path }}
        run: |
          echo "SERVICE_ACCOUNT_KEY=$(cat "${SERVICE_ACCOUNT_KEY_PATH}" | tr -d '\n')" >> $GITHUB_ENV

      - name: Download artifacts
        id: download-artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: inputs.build_artifact_name != ''
        with:
          name: ${{ inputs.build_artifact_name }}
          path: ${{ inputs.build_artifact_path }}

      - name: Firebase deploy
        id: firebase-deploy
        uses: FirebaseExtended/action-hosting-deploy@e2eda2e106cfa35cdbcf4ac9ddaf6c4756df2c8c # v0.10.0
        with:
          firebaseServiceAccount: "${{ env.SERVICE_ACCOUNT_KEY }}"
          projectId: ${{ inputs.gcp_project_id }}
          entryPoint: ${{ inputs.entry_point }}
          channelId: live

      - name: Add comment with the web url
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          MESSAGE_BODY: "The firebase hosting site in ${{ inputs.environment }} is deployed to the live channel" # pending bugfix: is available at ${{ steps.firebase-deploy.outputs.details_url }}"
          ALL_URLS: ${{ steps.firebase-deploy.outputs.urls }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.MESSAGE_BODY
            });
