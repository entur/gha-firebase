name: Entur/Firebase/Preview

# used for creating firebase previews for use in ie: PRs

on:
  workflow_call:
    inputs:
      gcp_project_id:
        required: true
        type: string
        description: "GCP Project ID"
      environment:
        required: true
        type: string
        description: "Environment to deploy to (dev, tst, prd)"
      entry_point:
        type: string
        description: "Entry point folder to deploy"
        default: "."
      build_artifact_name:
        description: "Name of GitHub artifact to add to build"
        type: string
      build_artifact_path:
        description: "Path to the artifact"
        type: string
        default: "build"
      preview_expire:
        type: string
        description: "Preview expire time"
        default: "7d"
      timeout_minutes:
        description: "Timeout in minutes"
        type: number
        default: 20
    outputs:
      details_url:
        value: ${{ jobs.deploy_preview.outputs.details_url }}
      urls:
        value: ${{ jobs.deploy_preview.outputs.urls }}

jobs:
  deploy_preview:
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout_minutes }}
    environment: ${{ inputs.environment }}
    outputs:
      details_url: ${{ steps.firebase-deploy-preview.outputs.details_url }}
      urls: ${{ steps.firebase-deploy-preview.outputs.urls }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Authenticate with GCP
        id: auth
        uses: "google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093" # v3.0.0
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT }}
          create_credentials_file: true

      - name: Set service account key
        env:
          SERVICE_ACCOUNT_KEY_PATH: ${{ steps.auth.outputs.credentials_file_path }}
        run: |
          echo "SERVICE_ACCOUNT_KEY=$(cat "${SERVICE_ACCOUNT_KEY_PATH}" | tr -d '\n')" >> $GITHUB_ENV

      - name: Download artifacts
        id: download-artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: inputs.build_artifact_name != ''
        with:
          name: ${{ inputs.build_artifact_name }}
          path: ${{ inputs.build_artifact_path }}

      - name: Set CHANNEL_ID for preview deployment
        env:
          GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
          REF: ${{ github.head_ref || github.ref_name }}
        run: |

          CHANNEL_ID="preview-${{ github.event.number }}-${REF}"
          FULL_LINK="${GCP_PROJECT_ID}-${CHANNEL_ID}"

          if [ ${#FULL_LINK} -gt 63 ]; then
            MAX_CHANNEL_LENGTH=$((63 - ${#GCP_PROJECT_ID} - 1))
            CHANNEL_ID="${CHANNEL_ID:0:MAX_CHANNEL_LENGTH}"
          fi

          echo "CHANNEL_ID=${CHANNEL_ID}" >> $GITHUB_ENV

      - name: Firebase deploy preview
        id: firebase-deploy-preview
        uses: FirebaseExtended/action-hosting-deploy@e2eda2e106cfa35cdbcf4ac9ddaf6c4756df2c8c # v0.10.0
        with:
          firebaseServiceAccount: "${{ env.SERVICE_ACCOUNT_KEY }}"
          projectId: ${{ inputs.gcp_project_id }}
          entryPoint: ${{ inputs.entry_point }}
          channelId: ${{ env.CHANNEL_ID }}
          expires: ${{ inputs.preview_expire }}

      - name: Add comment with preview url
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          DETAILS_URL: ${{ steps.firebase-deploy-preview.outputs.details_url }}
          EXPIRES_FORMATTED: ${{ steps.firebase-deploy-preview.outputs.expire_time_formatted }}
          PREVIEW_EXPIRE: ${{ inputs.preview_expire }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = '<!-- firebase-hosting-preview -->';
            const shortSha = context.sha.slice(0, 7);
            const env = process.env.ENVIRONMENT;
            const detailsUrl = process.env.DETAILS_URL;
            const expiresFormatted = process.env.EXPIRES_FORMATTED;
            const previewExpire = process.env.PREVIEW_EXPIRE;

            const header = `Preview for this PR in \`${env}\` (updated for commit ${shortSha}):`;
            const urlLine = detailsUrl || 'Preview URL unavailable';

            let expiresLine = '';
            if (expiresFormatted) {
              expiresLine = `(Expires ${expiresFormatted})`;
            } else if (previewExpire) {
              expiresLine = `(Expires in ${previewExpire})`;
            }

            const body = `${header}\n\n${urlLine}\n${expiresLine}\n${marker}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(
              (comment) =>
                comment.user?.type === 'Bot' &&
                comment.body &&
                comment.body.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
